# Volatility Malware and Yara rule

## Questions

1. find the ransomware process
   - see steps
2. extract the ransomware process volatility2 -f mem.vmem --profile xy procdump --pid xy --dump-dir . or volatility3 -f mem.vmem windows.pslist.PsList --pid xy --dump
    - see steps (found pid: 3496)
3. identify the type of ransomware by using an online tool. Document each of your steps.
    - Ransomware "Ryuk" (see steps)
    - https://www.trendmicro.com/de_de/what-is/ransomware/ryuk-ransomware.html
4. if you could find the encryption key from the memory, would it be possible to decipher the data? Please explain
    - Probably but limited: Ryuik encrypts the files with a symmetric algorithm, whose key is encrypted with RSA-4096. While the private key is never on the system, if we find the symmetric key that is actually used to encrypt a file, we can decrypt it. However, each file is encrypted with a different key and that is not enough to reverse the encryption.
5. when exactly, (time, date) was the executable created on the disk? Use the mftparser plugin.
    - running: `volatility3 -f ./vmware-win-infected.vmem windows.mftscan.MFTScan | grep keepass_installer` (locally didnt have a plugin called mftparser) I get the data from MFT table for the keypass_installer file. The file was created at the following date time: 2021-06-24 23:00:51.000000 (Process started: 2021-06-24 23:01:24.000000)
1. make assumptions relying on answers 1-5 on how the executable made its way to the machine. Justify your answer.
    - My assumption: 
      - User started pc at around 2021-06-24 22:52:35 (indicator process start times)
      - Downloaded the malicous file at around 23:00:51 (possibly from the browser as it is "C:\Users\victim\Downloads\")
    - User clicked on it a little later (23:01:24) an therefore activated the ransomware (indicator: parent process is explorer.exe)
2. create a simple YARA rule to search for the ransomware on other systems. The rule must match the string RYUKTM and files smaller than 250 kilo bytes.
    - see rule in step. It makes sense to limit the filesize in order reduce CPU and IO cost when we scan many systems (for example by using velociraptor)


**Security questions**
- explain what you have learned
    - mainly see steps and answers
    - Some information is not available, be it that some pages are swapped out and therefore memory is not present or for reasons mysterious to me (like the missing IP's).
    - Some leads might nowhere (or at least for someone with my experience they would be a dead end)
    - experience is probably required to do this in the field
    - know your tools but also the underlying mechanism (to some degreee) and OS
- what is the difference between windows.vadyarascan.VadYaraScan and yarascan.YaraScan
    - windows.vadyarascan.VadYaraScan only works for windows systems, yarascan.YaraScan works for all

## Steps

**Preconditions**
- Volatility, Yara etc. installed
- Memory dump downloaded and unzipped

**Get basic info**
`volatility3 -f vmware-win-infected.vmem windows.info` -> PE MajorOperatingSystemVersion	10
64bit

**Netscan**
`volatility3 -f vmware-win-infected.vmem windows.netscan`
lots of UDP connections, from svchost.exe, svchost.exe. There seems to be no IP address available

**pstree**
`volatility3 -f vmware-win-infected.vmem windows.pstree`
Most suspicious entry: 
4	0	System	0xc60f5c843040	97	-	N/A	False	2021-06-24 22:52:24.000000 	N/A
* 1608	4	MemCompression	0xc60f5d8fe040	16	-	N/A	False	2021-06-24 22:52:35.000000 	N/A
* 244	4	smss.exe	0xc60f5d5b2040	4	-	N/A	False	2021-06-24 22:52:24.000000 	N/A
** 388	244	smss.exe	0xc60f5d7cd780	0	-	1	False	2021-06-24 22:52:26.000000 	2021-06-24 22:52:27.000000 
*** 408	388	csrss.exe	0xc60f5db70080	11	-	1	False	2021-06-24 22:52:26.000000 	N/A
*** 448	388	winlogon.exe	0xc60f5db94080	5	-	1	False	2021-06-24 22:52:27.000000 	N/A
**** 732	448	dwm.exe	0xc60f5dca8080	12	-	1	False	2021-06-24 22:52:29.000000 	N/A
**** 2540	448	userinit.exe	0xc60f5dfd1780	0	-	1	False	2021-06-24 22:52:47.000000 	2021-06-24 22:53:27.000000 
***** 2556	2540	explorer.exe	0xc60f5e015400	74	-	1	False	2021-06-24 22:52:47.000000 	N/A
****** 3496	2556	keepass_instal	0xc60f5d292780	2	-	1	True	2021-06-24 23:01:24.000000 	N/A

Startup time of OS seems to be around: 2021-06-24 22:52:24  as all/most process are started then or shortly afterwards (indicator that malware was persisted?)

**windows.cmdline**
`volatility3 -f vmware-win-infected.vmem windows.cmdline`

Extremly suspicious:  
3496	keepass_instal	"C:\Users\victim\Downloads\keepass_installer.EXE" 


**windows dumpfile (step 5+6)**
- Failed attempt: `volatility3 -f vmware-win-infected.vmem windows.dumpfiles --pid 3496`  (first `apt-get install capstone-tool python3-capstone` )
    - but we get an error :-(
- `volatility3 -f vmware-win-infected.vmem windows.pslist.PsList --pid 3496 --dump`
  - we get the dump file: "pid.3496.0x35000000.dmp"
  - From my understanding

**Initial Yara scan**
Steps: 
- Yara (relativly unspecific)
  - `cd /opt/applic/yara-rules`
  - `yara -w ./index.yar /home/hacker/Downloads/pid.3496.0x35000000.dmp`
  - Multiple hits (not complete): DebuggerCheck__QueryInfo, anti_dbg, maldoc_find_kernel32_base_method_1, maldoc_getEIP_method_1  -> some anti malware analysis methods detected + malware indicators
- Analysis by https://www.hybrid-analysis.com/  
    - Result: Is detected as malware Ransom.Ryuk


**More Yara scan for Ryuk**
- Yara rule 1 (tried with 2 yara plugins)
    - get rule: `wget https://raw.githubusercontent.com/colincowie/Yara-Rules/master/MALW/Ryuk.yar`
    - `volatility3 -f ./vmware-win-infected.vmem windows.vadyarascan.VadYaraScan --yara-file ./Ryuk.yar` -> no result (seems to not return)
    - `volatility3 -f ./vmware-win-infected.vmem yarascan.YaraScan --yara-file ./Ryuk.yar` -> no result
- Yara rule 2 (also no result)
    - `wget https://raw.githubusercontent.com/advanced-threat-research/Yara-Rules/master/ransomware/RANSOM_Ryuk.yar`
    - plugin 1: `volatility3 -f ./vmware-win-infected.vmem windows.vadyarascan.VadYaraScan --yara-file ./RANSOM_Ryuk.yar`
    - plugin 2: `volatility3 -f ./vmware-win-infected.vmem yarascan.YaraScan --yara-file ./RANSOM_Ryuk.yar`
- Other built in yara rules (starting from `cd /opt/applic/yara-rules`)
    - `volatility3 -f /home/hacker/Downloads/vmware-win-infected.vmem windows.vadyarascan.VadYaraScan --yara-rule ./index.yar`
    - `volatility3 -f /home/hacker/Downloads/vmware-win-infected.vmem yarascan.YaraScan --yara-rule ./index.yar`
    - No results (not sure how we could expect to have specific results for Ryuk here)
      - How is this different 


**My own yara rule**

```
rule ryuktm
{
 meta:
	description = "RYUKTM malware"
 strings:
	$ryuktm = "RYUKTM"
 condition:
	filesize < 250KB and $ryuktm
}
```

Run rule: 
- Directly: `yara ./myrule.yar ./pid.3496.0x35000000.dmp` -> memory dump matches yara rule
- Using volatilty: `volatility3 -f ./vmware-win-infected.vmem yarascan.YaraScan --yara-file ./myrule.yar` > success, rule detected

## Varia

Links: 
https://blog.onfvp.com/post/volatility-cheatsheet/
https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/memory-dump-analysis/volatility-cheatsheet

## My questions
How is this different (both started from `cd /opt/applic/yara-rules`): 
    - `yara -w ./index.yar /home/hacker/Downloads/pid.3496.0x35000000.dmp` -> will return matches
    - `volatility3 -f /home/hacker/Downloads/vmware-win-infected.vmem windows.vadyarascan.VadYaraScan --yara-rule ./index.yar`
    - we use yara directly and we get results, in the other case we don't get results