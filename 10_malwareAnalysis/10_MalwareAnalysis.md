# Malware analysis

## Tools & Sites

Dissassmbler
- Ghidra
    - see reverse engineering
- and many more (some commercial)

Sandbox
- Cuckoo (free)
    - https://cuckoosandbox.org/
    - https://github.com/cuckoosandbox/cuckoo  (github)
    - https://mlwr.ee/ (Online service)
- VirusTotal (commercial)
    - https://www.virustotal.com/gui/home/upload
- JoeSandbox (commercial)
    - https://www.joesandbox.com/analysispaged/0


Packers/Unpackers
- Unipacker (free)
    - https://github.com/unipacker/unipacker
- unpac (commercial)
    https://www.unpac.me/#/


Malware samples (careful when downloading and experimenting)
    - Malware Bazaar
        - https://bazaar.abuse.ch/
        - goal of sharing malware samples with the infosec community
    - Zoo
        - https://github.com/ytisf/theZoo
    - malshare
        https://malshare.com/ 
        (not checked out)


*Remark: see pdf (not everything listed here)*


## Identifying malware


**YARA rules**
describes markers of malware (as usually a simple hash is easily bypassed, just changing a byte in the data section)

Some rule excerpts examples: 
-  {68 [-3] 07 ...}     -> means between 68 and 07 can be 0 or 3 bytes
- { 00 [1-5]FF ...}
- and for any i in (1 .. #a3)         ->   will loop through all occurences of variabel $a3
- and for any i in (1 .. -#a3): (uint8(@a3[i] + 2) == uint8(@a3[i] + 5))
    - @a3[i]  -> occurence in loop
    - @a3[i] + 2 -> points to 3 byte (which means it has to be variable like ??)
- and !a4 > 10   -> variable $a4 needs to be at least 11 bytes (! is for lenght) 

- $mz at 0     -> must be at the beginning
- uint32(uint32(0x3C)) == 0x00004550   -> at memory address 0x3C is a pointer to another memory address that has to have the value  0x00004550


*Remark: There are plugins for yara rules (syntax highlighting and maybe more)*

Website and how to get started
- https://yara.readthedocs.io/en/stable/gettingstarted.html
- on windows dowload the binaries and then in commandline run: 
    - `yara64 -r testRule.yara "C:\yara-4.3.1-2141-win64\testFile.txt"`  (testRule.yara is the file with yara rules)

## Anti-Analysis Dissassembly

Dissassemblers
    - linear dissasemblers -> just tries to interpret each line as code (and not as data)
        - can be fooled relativly easily via jump instructions
    - flow based dissassembler -> tries to interpret the code (example Ghidra)

Ways to fool flow based dissassemblers
    - Data insertion (via conditional jump)
    - Empty return
    - Instruction weaving

*Remark: details see pdf*


## Anti-Analysis Anti Debugging

Hardware-Breakpoint: there are special CPU registers in which you can place memory address
Sortware-Breakpoints: changes actual source code: special instrucion 0xCC  (which causes an interuppt for the debugger)


**make debugging more difficult**
- app does something different when debugger is attached (windows has api for this)
- software breakpoints change application
    - app can scan own code for 0xCC (Software-Breakpoint instrcution)
    - more see pdf
        - countermeasure: hardware breakpoints
- check elapsed time between instructions / exception: when we are slow app assumes that it is debugged (and then does something different)
    - creator assumes that we set a breakpoint in case of exceptions / or some instructions

Countermeasures: 
    - Hardware breakpoints (for Software breakpoint trickery)
    - Modify flags
    - Patch program
    - etc (see flag)



## Anti-Analysis Packing

**What is packing**
actual code is not distributed in plain text but packed and it must be unpacked before it runs. (see pdf)
How to get to actual code: 
- get a tool which does the unpacking (maybe the packer itself)
- run the programm which first unpackes and then do a memory dump (original imports have to ok but there are tools for this)


Check if exe is packed: 
- https://manalyzer.org  (found this myself.. probably better ways)
- or some other tool (to check)


"unipacker" first steps  (linux)
- Installation
    - Install Yara (see above, without it won't run)
    - Install using according to  https://github.com/unipacker/unipacker or https://pypi.org/project/unipacker/
    - Problem not working on Kali Linux (Live CD)
        - Probable reason: wrong phyton version (required 3.6 -3.10, higher versions wont work) 7.5.2023
        - Probably use "Virtual environment (venv)" (not tried.. see Pyhton infos)
        - or maybe https://stackoverflow.com/questions/52584907/how-to-downgrade-python-from-3-7-to-3-6 


- First steps
    - https://www.youtube.com/watch?v=1v8ZB7as59g 
    - https://stackoverflow.com/questions/52584907/how-to-downgrade-python-from-3-7-to-3-6


UPX (already installed on Kali Linux)
- https://upx.github.io/
- https://github.com/upx/upx
- `upx --best -d sample2.exe` -> will unpack/decompress the file

## Varia

**Tools and links**
- https://appimage.github.io/XPEViewer/

- orans: anti debugging/reverse engineering tool 
    - will be very hard to reverse engineer (at least that is what website claims)
    - not part of lecture

**Git-repos**
https://github.com/ti-ng/mwa-lecture  (contains malware)
https://github.com/ti-ng/mwa-lab



**some helful commands (a bit random)**
- `diff <(xxd orig.exe) <(xxd u2.exe)` compare files
- `pwd` run programm pwd
- `echo $PWD` -> print output of variable $PWD
- `echo $(pwd)` -> TODO ->  what is happening.. probably run pwd programm end then echo it?

**debofuscation with Ghidra**
- check C and Assembly (mainly assembly)
    - some links (should also be the corresponding md files):
    - https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf (good overview about core stuff)
    - https://en.wikipedia.org/wiki/X86_instruction_listings instructions
    - https://www.felixcloutier.com/x86/ (also instructions)
    - http://www.mathemainzel.info/files/x86asmref.html (Mnemonics and opcodes)
    - https://faydoc.tripod.com/cpu/jc.htm  (instructions...good for jump instructions)
- check static and dynamic deobfuscation


**Sprechstunde Video**
- https://ostch.sharepoint.com/teams/TS-CASCyberSecurity20222023/_layouts/15/stream.aspx?id=%2Fteams%2FTS%2DCASCyberSecurity20222023%2FFreigegebene%20Dokumente%2FGeneral%2FRecordings%2FSprechstunde%20Lab%2011%2D20230511%5F170515%2DMeeting%20Recording%2Emp4
- https://ostch.sharepoint.com/teams/TS-CASCyberSecurity20222023/Freigegebene%20Dokumente/General/Recordings/Debriefing%20Lab%2011-20230517_170335-Meeting%20Recording.mp4?web=1 
    - Solution video
    - Maybe here we find good exercises: https://crackmes.one/  

**size**
- Kib -> 1000 bytes
- KB -> 1024 bytes

**C stuff**
- 0 is false, any other value is true
