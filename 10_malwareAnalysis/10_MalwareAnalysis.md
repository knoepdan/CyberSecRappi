# Malware analysis

## Tools
see pdf
 (zoo: source of various malwares)


## Identifying malware

**YARA rules**
describes markers of malware (as usually a simple hash is easily bypassed, just changing a byte in the data section)

Some rule excerpts examples: 
-  {68 [-3] 07 ...}     -> means between 68 and 07 can be 0 or 3 bytes
- { 00 [1-5]FF ...}
- and for any i in (1 .. #a3)         ->   will loop through all occurences of variabel $a3
- and for any i in (1 .. -#a3): (uint8(@a3[i] + 2) == uint8(@a3[i] + 5))
    - @a3[i]  -> occurence in loop
    - @a3[i] + 2 -> points to 3 byte (which means it has to be variable like ??)
- and !a4 > 10   -> variable $a4 needs to be at least 11 bytes (! is for lenght) 

- $mz at 0     -> must be at the beginning
- uint32(uint32(0x3C)) == 0x00004550   -> at memory address 0x3C is a pointer to another memory address that has to have the value  0x00004550



## Anti-Analysis 

see pdf





## Anti-Analysis Anti Debugging

Hardware-Breakpoint: there are special CPU registers in which you can place memory address
Sortware-Breakpoints: changes actual source code: special instrucion 0xCC  (which causes an interuppt for the debugger)


**make debugging more difficult**
- app does something different when debugger is attached (windows has api for this)
- software breakpoints change application
    - app can scan own code for 0xCC (Software-Breakpoint instrcution)
    - more see pdf
        - countermeasure: hardware breakpoints
- check elapsed time between instructions / exception: when we are slow app assumes that it is debugged (and then does something different)
    - creator assumes that we set a breakpoint in case of exceptions / or some instructions

Countermeasures: 
    - Hardware breakpoints (for Software breakpoint trickery)
    - Modify flags
    - Patch program
    - etc (see flag)



## Anti-Analysis Packing

**What is packing**
actual code is not distributed in plain text but packed and it must be unpacked before it runs. (see pdf)
How to get to actual code: 
- get a tool which does the unpacking (maybe the packer itself)
- run the programm which first unpackes and then do a memory dump (original imports have to ok but there are tools for this)




## Varia

**size**
- Kib -> 1000 bytes
- KB -> 1024 bytes


**Git-repos**
https://github.com/ti-ng/mwa-lecture  (contains malware)
https://github.com/ti-ng/mwa-lab